// --------------------------- Parameters -------------------------------------
params {
  // Required parameters
  sra           = null
  taxa          = null
  taxdump       = null
  gtdb_ncbi_map = null
  sandpiper_db  = null
  singlem_db    = null
  uniprot_db    = null

  // Optional parameters
  help        = false
  version     = '0.2.0'
  outdir      = 'output'
  max_retries = 3

  // Resource parameters
  max_cpus    = 4
  max_memory  = 8.GB
  max_time    = 24.h
}


// ---------------------------- Containers ------------------------------------
process {
  errorStrategy = { task.attempt <= params.max_retries ? 'retry' : 'ignore' }
  maxRetries    = params.max_retries
  maxErrors     = -1

  // shell = ['/bin/bash', '-euo', 'pipefail']

  withName: VALIDATE_TAXA {
    errorStrategy = 'terminate'
    container = "quay.io/asuq1617/nf-sra_screen_taxa:${params.version}"
    queue = 'short'
    cpus   = { Math.min( 1 * task.attempt, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 10.min * task.attempt, params.max_time ].min() }
  }

  withName: DOWNLOAD_SRA_METADATA {
    container = "quay.io/asuq1617/iseq:1.9.7"
    queue  = 'short'
    cpus   = { Math.min( 1 * task.attempt, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 1.h * task.attempt, params.max_time ].min() }
  }

  withName: SANDPIPER {
    container = "quay.io/asuq1617/singlem:0.20.3"
    queue  = 'short'
    cpus   = { Math.min( 1 * task.attempt, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 1.h * task.attempt, params.max_time ].min() }
  }

  withName: DOWNLOAD_SRR {
    container = "quay.io/asuq1617/iseq:1.9.7"
    cpus   = { Math.min( 8 * task.attempt, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 2.h * task.attempt, params.max_time ].min() }
  }

  withName: SINGLEM {
    container = "quay.io/asuq1617/singlem:0.20.3"
    cpus   = { Math.min( 32 * task.attempt, params.max_cpus as int ) }
    memory = { [ 32.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 2.h * task.attempt, params.max_time ].min() }
  }

  withName: METASPADES {
    container = "quay.io/asuq1617/nf-sra_screen_metaspades:${params.version}"
    queue  = { task.attempt < 3 ? 'compute' : 'largemem'}
    cpus   = { task.attempt < 3 ? Math.min( 128, params.max_cpus as int ) : Math.min( 36, params.max_cpus as int )}
    memory = { task.attempt < 3 ? [ 500.GB ,  params.max_memory ].min() : [ 750.GB ,  params.max_memory ].min()}
    time   = { task.attempt < 3 ? [ 96.h, params.max_time ].min() : [ 336.h, params.max_time ].min()}
  }

  withName: METAFLYE_NANO {
    container = "quay.io/asuq1617/nf-sra_screen_metaflye:${params.version}"
    queue  = { task.attempt < 3 ? 'compute' : 'largemem'}
    cpus   = { task.attempt < 3 ? Math.min( 128, params.max_cpus as int ) : Math.min( 36, params.max_cpus as int )}
    memory = { task.attempt < 3 ? [ 500.GB, params.max_memory ].min() : [ 750.GB, params.max_memory ].min()}
    time   = { task.attempt < 3 ? [ 96.h, params.max_time ].min() : [ 336.h, params.max_time ].min()}
  }

  withName: METAFLYE_PACBIO {
    container = "quay.io/asuq1617/nf-sra_screen_metaflye:${params.version}"
    queue  = { task.attempt < 3 ? 'compute' : 'largemem'}
    cpus   = { task.attempt < 3 ? Math.min( 128, params.max_cpus as int ) : Math.min( 36, params.max_cpus as int )}
    memory = { task.attempt < 3 ? [ 500.GB, params.max_memory ].min() : [ 750.GB, params.max_memory ].min()}
    time   = { task.attempt < 3 ? [ 96.h, params.max_time ].min() : [ 336.h, params.max_time ].min()}
  }

  withName: MYLOASM {
    container = "quay.io/asuq1617/nf-sra_screen_myloasm:${params.version}"
    queue  = { task.attempt < 3 ? 'compute' : 'largemem'}
    cpus   = { task.attempt < 3 ? Math.min( 128, params.max_cpus as int ) : Math.min( 36, params.max_cpus as int )}
    memory = { task.attempt < 3 ? [ 500.GB, params.max_memory ].min() : [ 750.GB, params.max_memory ].min()}
    time   = { task.attempt < 3 ? [ 96.h, params.max_time ].min() : [ 336.h, params.max_time ].min()}
  }

  withName: DIAMOND {
    container = "quay.io/biocontainers/diamond:2.1.13--h13889ed_0"
    queue  = { task.attempt < 3 ? 'compute' : 'largemem'}
    cpus   = { task.attempt < 3 ? Math.min( 128, params.max_cpus as int ) : Math.min( 36, params.max_cpus as int )}
    memory = { task.attempt < 3 ? [ 500.GB, params.max_memory ].min() : [ 750.GB, params.max_memory ].min()}
    time   = { task.attempt < 3 ? [ 96.h, params.max_time ].min() : [ 336.h, params.max_time ].min()}
  }

  withName: BLOBTOOLS {
    container = "docker.io/genomehubs/blobtoolkit:4.4.6"
    queue = 'short'
    cpus   = { Math.min( 16 * task.attempt, params.max_cpus as int ) }
    memory = { [ 50.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 2.h * task.attempt, params.max_time ].min() }
  }

  withName: EXTRACT_TAXA {
    container = "quay.io/asuq1617/nf-sra_screen_taxa:${params.version}"
    executor = 'local'
    cpus   = { Math.min( 1, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 1.h * task.attempt, params.max_time ].min() }
  }

  withName: LOG_FAILED_PROCESS {
    container = "quay.io/asuq1617/nf-sra_screen_taxa:${params.version}"
    executor = 'local'
    cpus   = { Math.min( 1, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 1.h * task.attempt, params.max_time ].min() }
  }

  withName: APPEND_SUMMARY {
    container = "quay.io/asuq1617/nf-sra_screen_taxa:${params.version}"
    executor = 'local'
    cpus   = { Math.min( 1, params.max_cpus as int ) }
    memory = { [ 4.GB * task.attempt,  params.max_memory ].min() }
    time   = { [ 1.h * task.attempt, params.max_time ].min() }
  }
}


// --------------------------- Singularity engine -----------------------------
singularity {
  autoMounts  = true
  cacheDir    = "${baseDir}/.singularity-cache"
  pullTimeout = '100m'
  runOptions  = '--cleanenv'
}


// ------------------------------ Reports -------------------------------------
timeline {
  enabled   = true
  file      = "execution-reports/timeline.html"
  overwrite = true
}

report {
  enabled   = true
  file      = "execution-reports/report.html"
  overwrite = true
}

trace {
  enabled   = true
  file      = "execution-reports/trace.txt"
  overwrite = true
}


// ------------------------------ Misc ----------------------------------------
workDir = "work"
// cleanup = true


// ------------------------------ Profiles ------------------------------------
profiles {
  oist {
    includeConfig "${projectDir}/conf/oist.config"
  }

  slurm {
    process.executor = 'slurm'
    singularity.enabled = true
    executor.queueSize = 2000
    params.max_cpus    = 16
    params.max_memory  = 32.GB
    params.max_time    = 24.h
  }

  local {
    process.executor = 'local'
    docker.enabled = true
    executor.queueSize = 4
    params.max_cpus    = 8
    params.max_memory  = 16.GB
    params.max_time    = 24.h
  }

  debug {
    docker.enabled = true
    trace.fields = 'task_id,process,tag,status,hash,cpus,memory,time,realtime,exit,attempt'
    executor.queueSize = 1
    params.max_cpus    = 4
    params.max_memory  = 8.GB
    params.max_time    = 24.h
  }

  test {
  }
}